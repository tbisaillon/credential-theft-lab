{
    "docs": [
        {
            "location": "/",
            "text": "Credential Theft Lab\n\n\n\nBackground\n\n\nPhishing attacks to obtain valid corporate credentials are one of the common \nfactors in many breaches today.  If the attacker caon obtain valid credentials,\nthey can walk right into the enterprise network bypassing most security solutions and not arouse any suspicions.\n\n\nIn this lab, we will see how we can use URL Filtering capabilities to prevent \nexposure of corporate credentials.\n\n\n\n\nLab Diagram\n\n\nYou will instantiate an AWS CloudFormation template that builds the below\nenvironment.  It will create the VPC, subnets, security groups, and instances\nshown.  You will then connect into the environment using the GlobalProtect client.\n\n\n\n\nAccess Details\n\n\nYou will need this information throughout the lab.\n\n\nTable 1\n - Lab Instances\n\n\n\n\n\n\n\n\nDevice\n\n\nIP\n\n\nUsername\n\n\nPassword\n\n\n\n\n\n\n\n\n\n\nFirewall\n\n\nSet by CloudFormation\n\n\nadmin\n\n\nSet by user\n\n\n\n\n\n\nDomain Controller\n\n\n10.0.1.10\n\n\nAdministrator\n\n\npaloalto\n\n\n\n\n\n\nRead Only Domain Controller\n\n\n10.0.1.11\n\n\nAdministrator\n\n\npaloalto\n\n\n\n\n\n\nWeb Server\n\n\n10.0.1.12\n\n\nAdministrator\n\n\npaloalto\n\n\n\n\n\n\nPhishing Site (Kali Linux)\n\n\n10.0.2.10\n\n\nkali\n\n\npaloalto\n\n\n\n\n\n\n\n\nTable 2\n - Corporate Active Directory Accounts - Credlab.local\n\n\n\n\n\n\n\n\nUsername\n\n\nPassword\n\n\n\n\n\n\n\n\n\n\nAdministrator\n\n\npaloalto\n\n\n\n\n\n\nuser1\n\n\npaloalto\n\n\n\n\n\n\nuser2\n\n\npaloalto\n\n\n\n\n\n\nuser3\n\n\npaloalto",
            "title": "Overview"
        },
        {
            "location": "/#background",
            "text": "Phishing attacks to obtain valid corporate credentials are one of the common \nfactors in many breaches today.  If the attacker caon obtain valid credentials,\nthey can walk right into the enterprise network bypassing most security solutions and not arouse any suspicions.  In this lab, we will see how we can use URL Filtering capabilities to prevent \nexposure of corporate credentials.",
            "title": "Background"
        },
        {
            "location": "/#lab-diagram",
            "text": "You will instantiate an AWS CloudFormation template that builds the below\nenvironment.  It will create the VPC, subnets, security groups, and instances\nshown.  You will then connect into the environment using the GlobalProtect client.",
            "title": "Lab Diagram"
        },
        {
            "location": "/#access-details",
            "text": "You will need this information throughout the lab.  Table 1  - Lab Instances     Device  IP  Username  Password      Firewall  Set by CloudFormation  admin  Set by user    Domain Controller  10.0.1.10  Administrator  paloalto    Read Only Domain Controller  10.0.1.11  Administrator  paloalto    Web Server  10.0.1.12  Administrator  paloalto    Phishing Site (Kali Linux)  10.0.2.10  kali  paloalto     Table 2  - Corporate Active Directory Accounts - Credlab.local     Username  Password      Administrator  paloalto    user1  paloalto    user2  paloalto    user3  paloalto",
            "title": "Access Details"
        },
        {
            "location": "/gettingstarted/",
            "text": "Getting Started\n\n\n\nEC2 Key Pair Creation\n\n\nIf you've never used AWS before, you will need to create a SSH key pair that \nwill be used for the initial login to EC2 instances.  If you've already got an \nSSH key pair that you would like to use in your desired region, feel free to \nskip this step.\n\n\n\n\nIn the EC2 section of the AWS console, click \nKey Pairs\n.\n\n\n\n\nClick \nCreate Key Pair\n, give your key pair a name, and click \nCreate\n.\n\n\n\n\nA SSH public/private key pair will be created for you, and the private key \nwill be downloaded by the browser.  This key pair will be used to log into the firewall instance.  \n\n\nFor more information, see the \nEC2 Key Pair documentation\n.\n\n\nCloudFormation\n\n\nIn CloudFormation, create a new stack using the following URL:\n\n\nhttps://raw.githubusercontent.com/mrichardson03/credential-theft-lab/master/credential-theft-lab.json\n\n\nThis will always point to the latest version of the template.\n\n\nCloudFormation will ask for a stack name.  You can call it whatever you want, but the rest of this \nguide assumes that it will be \nCredential-Theft-Lab\n.  Everything created by the template will \nuse the stack name as a prefix so you can easily identify them.\n\n\n\n\nThe two parameters for the stack are \nBootstrapBucketName\n and \nKeyName\n.  The bootstrap bucket \ncontains the initial configuration for the firewall (located \nhere\n for reference), and the \nKeyName dropdown should be used to select the SSH key pair you want to log into the firewall \ninitially.\n\n\n\n\nBe sure to check the box \"I acknowledge that AWS CloudFormation might create IAM resources\" when \ncreating the stack to create the bootstrap user and role.\n\n\nThe stack will create all the required AWS resources for you.  After the stack has finished, click \nthe \nOutputs\n tab, and make note of the \nFirewallManagementInterface\n IP address, and the \n\nFirewallUntrustInterface\n IP address.  They will be used to access the management interface of \nthe firewall and the GlobalProtect portal to access the rest of the environment.\n\n\nSecurity Group Configuration\n\n\nThe created management security group for the firewall does not allow inbound access by default.\n\nIn the AWS console, add HTTPS and SSH access from your IP to the \n\nCredential-Theft-Lab-FirewallManagementSecurityGroup\n.\n\n\n\n\n\n\nThe \nCredential-Theft-Lab-PublicSecurityGroup\n, which is associated to the firewall's untrust \ninterface is wide open and should need no modifications.\n\n\nLog In To Firewall\n\n\nAfter giving the firewall instance around 5-10 minutes to initialize and bootstrap, use your SSH key \nto log in as the admin user and set the admin password.\n\n\nGenerate GlobalProtect Portal Certificate\n\n\nThe bootstrap configuration for the firewall contains a certificate authority for you, but you need \nto create a certificate for the IP address of the firewall's untrust interface.\n\n\n\n\nUse it in place of \nPlaceholder-Cert\n in the \nGlobalProtect_SSL\n service profile.\n\n\n\n\nReplace External Gateway in GlobalProtect Portal Config\n\n\nIn the Agent config section of the GlobalProtect portal configuration, navigate to the \nExternal\n\ntab, and replace the external gateway IP address with your firewall's untrust interface.\n\n\n\n\nDownload/Activate GlobalProtect Client\n\n\nIf you don't have GlobalProtect installed on your laptop, download and activate the latest version \non the firewall so you can download it when connecting to the GlobalProtect portal.\n\n\nCreate Phishing Victim Account\n\n\nWe will be sending a phishing email as part of this lab.  You can either use your personal Gmail \naccount, or create a new one for this lab.",
            "title": "Getting Started"
        },
        {
            "location": "/gettingstarted/#ec2-key-pair-creation",
            "text": "If you've never used AWS before, you will need to create a SSH key pair that \nwill be used for the initial login to EC2 instances.  If you've already got an \nSSH key pair that you would like to use in your desired region, feel free to \nskip this step.   In the EC2 section of the AWS console, click  Key Pairs .   Click  Create Key Pair , give your key pair a name, and click  Create .   A SSH public/private key pair will be created for you, and the private key \nwill be downloaded by the browser.  This key pair will be used to log into the firewall instance.    For more information, see the  EC2 Key Pair documentation .",
            "title": "EC2 Key Pair Creation"
        },
        {
            "location": "/gettingstarted/#cloudformation",
            "text": "In CloudFormation, create a new stack using the following URL:  https://raw.githubusercontent.com/mrichardson03/credential-theft-lab/master/credential-theft-lab.json  This will always point to the latest version of the template.  CloudFormation will ask for a stack name.  You can call it whatever you want, but the rest of this \nguide assumes that it will be  Credential-Theft-Lab .  Everything created by the template will \nuse the stack name as a prefix so you can easily identify them.   The two parameters for the stack are  BootstrapBucketName  and  KeyName .  The bootstrap bucket \ncontains the initial configuration for the firewall (located  here  for reference), and the \nKeyName dropdown should be used to select the SSH key pair you want to log into the firewall \ninitially.   Be sure to check the box \"I acknowledge that AWS CloudFormation might create IAM resources\" when \ncreating the stack to create the bootstrap user and role.  The stack will create all the required AWS resources for you.  After the stack has finished, click \nthe  Outputs  tab, and make note of the  FirewallManagementInterface  IP address, and the  FirewallUntrustInterface  IP address.  They will be used to access the management interface of \nthe firewall and the GlobalProtect portal to access the rest of the environment.",
            "title": "CloudFormation"
        },
        {
            "location": "/gettingstarted/#security-group-configuration",
            "text": "The created management security group for the firewall does not allow inbound access by default. \nIn the AWS console, add HTTPS and SSH access from your IP to the  Credential-Theft-Lab-FirewallManagementSecurityGroup .    The  Credential-Theft-Lab-PublicSecurityGroup , which is associated to the firewall's untrust \ninterface is wide open and should need no modifications.",
            "title": "Security Group Configuration"
        },
        {
            "location": "/gettingstarted/#log-in-to-firewall",
            "text": "After giving the firewall instance around 5-10 minutes to initialize and bootstrap, use your SSH key \nto log in as the admin user and set the admin password.",
            "title": "Log In To Firewall"
        },
        {
            "location": "/gettingstarted/#generate-globalprotect-portal-certificate",
            "text": "The bootstrap configuration for the firewall contains a certificate authority for you, but you need \nto create a certificate for the IP address of the firewall's untrust interface.   Use it in place of  Placeholder-Cert  in the  GlobalProtect_SSL  service profile.",
            "title": "Generate GlobalProtect Portal Certificate"
        },
        {
            "location": "/gettingstarted/#replace-external-gateway-in-globalprotect-portal-config",
            "text": "In the Agent config section of the GlobalProtect portal configuration, navigate to the  External \ntab, and replace the external gateway IP address with your firewall's untrust interface.",
            "title": "Replace External Gateway in GlobalProtect Portal Config"
        },
        {
            "location": "/gettingstarted/#downloadactivate-globalprotect-client",
            "text": "If you don't have GlobalProtect installed on your laptop, download and activate the latest version \non the firewall so you can download it when connecting to the GlobalProtect portal.",
            "title": "Download/Activate GlobalProtect Client"
        },
        {
            "location": "/gettingstarted/#create-phishing-victim-account",
            "text": "We will be sending a phishing email as part of this lab.  You can either use your personal Gmail \naccount, or create a new one for this lab.",
            "title": "Create Phishing Victim Account"
        },
        {
            "location": "/priorconfiguration/",
            "text": "What's Been Done For You\n\n\n\nNote:\n This section is included for reference, and no action is needed on your part.\n\n\nRead Only Domain Controller\n\n\nUser-ID Agent and User-ID Agent Credential service have already been installed on the RODC.  The \nfollowing screen capture shows that the \n\"Import from User-ID Credential Agent\"\n is selected under \nthe Credentials tab in the User-ID Agent GUI.  This enables the User-ID agent to import the bloom\nfilter that the User-ID credential agent creates to represent users and the corresponding password \nhashes.\n\n\nUsers that should receive credential submission enforcement have been added to the \"Allowed RODC \nPassword Replication Group\".\n\n\nGoPhish On Kali Linux\n\n\nThe \nGoPhish\n tool has been set up on the Kali Linux instance to simulate \na phishing campaign.  Our campaign will use a fake Palo Alto Networks SSO landing page at \n\npaloaito.sso.com\n to capture domain credentials from our test users.",
            "title": "What's Been Done For You"
        },
        {
            "location": "/priorconfiguration/#read-only-domain-controller",
            "text": "User-ID Agent and User-ID Agent Credential service have already been installed on the RODC.  The \nfollowing screen capture shows that the  \"Import from User-ID Credential Agent\"  is selected under \nthe Credentials tab in the User-ID Agent GUI.  This enables the User-ID agent to import the bloom\nfilter that the User-ID credential agent creates to represent users and the corresponding password \nhashes.  Users that should receive credential submission enforcement have been added to the \"Allowed RODC \nPassword Replication Group\".",
            "title": "Read Only Domain Controller"
        },
        {
            "location": "/priorconfiguration/#gophish-on-kali-linux",
            "text": "The  GoPhish  tool has been set up on the Kali Linux instance to simulate \na phishing campaign.  Our campaign will use a fake Palo Alto Networks SSO landing page at  paloaito.sso.com  to capture domain credentials from our test users.",
            "title": "GoPhish On Kali Linux"
        },
        {
            "location": "/credentialphishing/",
            "text": "Credential Phishing Prevention\n\n\n\nThere are 3 methods to check for corporate credential submissions that you can use on the firewall\nto detect users when they submit credentials to web pages.\n\n\nThe three methods are:\n\n\n\n\nGroup Mapping\n\n\nIP User Mapping\n\n\nDomain Credential Filter\n\n\n\n\nIn this lab, you will configure the firewall to check submitted credentials via the \nDomain \nCredential Filter\n method.\n\n\n\n\nConfiguration Steps\n\n\n\nPhishing Campaign Configuration\n\n\nFrom your laptop, open the GlobalProtect Agent.  If you don't have it installed, install it when \nprompted by the portal.  Connect to your lab environment's GlobalProtect portal using any of the \nuser accounts listed in Table 2.\n\n\nAccess your phishing campaign admin site with the credentials \nadmin/gophish\n.\n\n\n\n\nIn the \nUsers & Groups\n tab, edit the \nPhishing Recipients\n \n\n\n\n\nChange the recipient to be your test email account.\n\n\n\n\nNow, in the \nCampaigns\n tab, click the \nNew Campaign\n button.\n\n\n\n\nFill out the campaign as shown, then click \nLaunch Campaign\n.  Pay particular attention to the \nmisspelled domain name \npaloaito.sso.com\n that we are spoofing!\n\n\n\n\nGoPhish will queue and send the emails.  You can refresh this page and check that an email has been\nsent to your test user.\n\n\n\n\nIf you want, log into your test email account, and verify that you've received your phishing email.\n\n\n\n\n\n\nFirewall Configuration\n\n\nLog in to the GUI of your firewall, and add a User-ID agent.\n\n\n\n\nName:\n RODC\n\n\nHost:\n 10.0.1.11\n\n\nPort:\n 5007\n\n\nMake sure the \nEnabled\n check box is ticked.\n\n\n\n\n\n\nNote:\n The service route configuration of the firewall has already been modified to communicate\nwith the User-ID agent via the firewall's trust interface.  To confirm it has been set up correctly,\nunder \nDevice > Setup > Services\n, select \nService Route Configuration\n and choose \n\nCustomize\n.  In the IPv4 tab, select UID Agent service and verify that it is the interface in \nthe \ntrust\n zone (ethernet1/2).\n\n\nCommit your changes.  After the commit completes, go back to the User-ID Agents tab.  The connected\ncolumn will change from orange to green.\n\n\n\n\nTo make sure our test URL is categorized the way we want it, create a custom URL category for the \nURL \npaloaito.sso.com\n.  \n(Note the misspelling!)\n\n\n\n\nSelect \nObjects > Security Profiles > URL Filtering\n and select the default URL Filtering profile.\nClone it, and change the cloned profile name to \"credential-phish-block\".  Use the Categories tab \nto set all URL categories to alert, but to block credential submissions.  \n\n\n\n\nNow go to the \nUser Credential Detection\n tab.  Choose \nUse Domain Credential Filter\n for the \nUser Credential Detection method, and set the log severity to \"high\".\n\n\n\n\nGo to the \nPolicies > Security\n tab, and create a new security policy.  Associate your new URL\nfiltering profile to the security policy with traffic from the GP zone to the PHISH zone.\n\n\n\n\nPolicy Name:\n Allow to Intranet\n\n\nSource Zone:\n GP\n\n\nDestination Zone:\n PHISH, TRUST\n\n\nApplication\n: any\n\n\nService:\n application-default\n\n\nAction:\n allow\n\n\nURL Profile:\n credential-phish-block\n\n\n\n\n\n\nCommit the configuration.\n\n\n\n\nVerification\n\n\nLog into your test email account.  You should see that a phishing email has been received.  The\nemail contains a link that will open a phishing webpage mimicking the Palo Alto Networks corporate\nSSO page.\n\n\nUpon clicking the link provided in the email, you will get a phishing page with a form to submit\nuser credentials.\n\n\n\n\nNote:\n If you are NOT connected via GlobalProtect to your lab environment, you will get an \n\"under construction\" web page similar to below.  Do not proceed until you get the test phishing \npage.\n\n\nEnter a username \nnot\n in Table 2, and any password you'd like.  Click \nLogin\n.\n\n\n\n\nAt this point, those credentials have been phished.  You will be redirected to a legitimate site.\n\n\n\n\nNow log in to your credential phishing campaign's admin web site.\n\n\n\n\nNext to the PANW campaign, click the View Results icon in the bottom right corner to get the \ncampaign details.  Scroll down to your username, click the triangle icon, and expand the details:\n\n\nScroll down to the bottom \"Submitted Data\" section, and click the triangle icon next to \"View \nDetails\".  You will see the username and password you entered.\n\n\n\n\nThe above steps you performed show how easy it is to steal user credentials.  Credential phishing\nis rampant.  It is easier than ever to phish a user for credentials.  This is especially true in\ntargetted attacks, where the attacker wants to get into a specific organaization.  A phishing attack\nmakes password complexity irrelevant; the attacker steals the password no matter how difficult it\nis.\n\n\nYou will do a second test, but first, let's find out what usernames are defined on your firewall.\nConnect to your firewall via SSH, and run the \nshow user ip-user-mapping all\n command.\n\n\n\n\nConfirm that your username is listed (it will be if you are connected to the lab environment via \nGlobalProtect).  You may see additional IP/user mappings.\n\n\nGo back to your test phishing account, and open the phishing email.  By clicking the link provided\nin the email, you will get to the phishing page again.\n\n\n\n\nTry submitting true \"corporate\" credentials by submitting the credentials you are connected to \nGlobalProtect with.\n\n\nSince the source IP address of a session had a known User-ID, and the HTTP POST parameter in that\nsession matched the password belonging to that User-ID, the firewall detected a credential \nsubmission and the URL will be blocked.\n\n\nYou will get this message:\n\n\n\n\nYou can see more info about this process using these commands:\n\n\n\n\nshow user user-id-agent state all\n\n\nless mp-log useridd.log\n - You can find detailed logs in useridd.log.  This log now includes \n  credential related logs, as well as bloomfilter updates.\n\n\n\n\nIn the output of \nshow user user-id-agent state all\n, look for the following:\n\n\n\n\nNow examine the firewall's URL filtering logs.  Locate the log that matches your username, and view\nthe log details.  Look for the \"credential detected\" flag.\n\n\n\n\nYou can close the browser tabs to Gmail and Gophish.  You're done with this section of the lab.",
            "title": "Credential Phishing Prevention"
        },
        {
            "location": "/credentialphishing/#phishing-campaign-configuration",
            "text": "From your laptop, open the GlobalProtect Agent.  If you don't have it installed, install it when \nprompted by the portal.  Connect to your lab environment's GlobalProtect portal using any of the \nuser accounts listed in Table 2.  Access your phishing campaign admin site with the credentials  admin/gophish .   In the  Users & Groups  tab, edit the  Phishing Recipients     Change the recipient to be your test email account.   Now, in the  Campaigns  tab, click the  New Campaign  button.   Fill out the campaign as shown, then click  Launch Campaign .  Pay particular attention to the \nmisspelled domain name  paloaito.sso.com  that we are spoofing!   GoPhish will queue and send the emails.  You can refresh this page and check that an email has been\nsent to your test user.   If you want, log into your test email account, and verify that you've received your phishing email.",
            "title": "Phishing Campaign Configuration"
        },
        {
            "location": "/credentialphishing/#firewall-configuration",
            "text": "Log in to the GUI of your firewall, and add a User-ID agent.   Name:  RODC  Host:  10.0.1.11  Port:  5007  Make sure the  Enabled  check box is ticked.    Note:  The service route configuration of the firewall has already been modified to communicate\nwith the User-ID agent via the firewall's trust interface.  To confirm it has been set up correctly,\nunder  Device > Setup > Services , select  Service Route Configuration  and choose  Customize .  In the IPv4 tab, select UID Agent service and verify that it is the interface in \nthe  trust  zone (ethernet1/2).  Commit your changes.  After the commit completes, go back to the User-ID Agents tab.  The connected\ncolumn will change from orange to green.   To make sure our test URL is categorized the way we want it, create a custom URL category for the \nURL  paloaito.sso.com .   (Note the misspelling!)   Select  Objects > Security Profiles > URL Filtering  and select the default URL Filtering profile.\nClone it, and change the cloned profile name to \"credential-phish-block\".  Use the Categories tab \nto set all URL categories to alert, but to block credential submissions.     Now go to the  User Credential Detection  tab.  Choose  Use Domain Credential Filter  for the \nUser Credential Detection method, and set the log severity to \"high\".   Go to the  Policies > Security  tab, and create a new security policy.  Associate your new URL\nfiltering profile to the security policy with traffic from the GP zone to the PHISH zone.   Policy Name:  Allow to Intranet  Source Zone:  GP  Destination Zone:  PHISH, TRUST  Application : any  Service:  application-default  Action:  allow  URL Profile:  credential-phish-block    Commit the configuration.",
            "title": "Firewall Configuration"
        },
        {
            "location": "/credentialphishing/#verification",
            "text": "Log into your test email account.  You should see that a phishing email has been received.  The\nemail contains a link that will open a phishing webpage mimicking the Palo Alto Networks corporate\nSSO page.  Upon clicking the link provided in the email, you will get a phishing page with a form to submit\nuser credentials.   Note:  If you are NOT connected via GlobalProtect to your lab environment, you will get an \n\"under construction\" web page similar to below.  Do not proceed until you get the test phishing \npage.  Enter a username  not  in Table 2, and any password you'd like.  Click  Login .   At this point, those credentials have been phished.  You will be redirected to a legitimate site.   Now log in to your credential phishing campaign's admin web site.   Next to the PANW campaign, click the View Results icon in the bottom right corner to get the \ncampaign details.  Scroll down to your username, click the triangle icon, and expand the details:  Scroll down to the bottom \"Submitted Data\" section, and click the triangle icon next to \"View \nDetails\".  You will see the username and password you entered.   The above steps you performed show how easy it is to steal user credentials.  Credential phishing\nis rampant.  It is easier than ever to phish a user for credentials.  This is especially true in\ntargetted attacks, where the attacker wants to get into a specific organaization.  A phishing attack\nmakes password complexity irrelevant; the attacker steals the password no matter how difficult it\nis.  You will do a second test, but first, let's find out what usernames are defined on your firewall.\nConnect to your firewall via SSH, and run the  show user ip-user-mapping all  command.   Confirm that your username is listed (it will be if you are connected to the lab environment via \nGlobalProtect).  You may see additional IP/user mappings.  Go back to your test phishing account, and open the phishing email.  By clicking the link provided\nin the email, you will get to the phishing page again.   Try submitting true \"corporate\" credentials by submitting the credentials you are connected to \nGlobalProtect with.  Since the source IP address of a session had a known User-ID, and the HTTP POST parameter in that\nsession matched the password belonging to that User-ID, the firewall detected a credential \nsubmission and the URL will be blocked.  You will get this message:   You can see more info about this process using these commands:   show user user-id-agent state all  less mp-log useridd.log  - You can find detailed logs in useridd.log.  This log now includes \n  credential related logs, as well as bloomfilter updates.   In the output of  show user user-id-agent state all , look for the following:   Now examine the firewall's URL filtering logs.  Locate the log that matches your username, and view\nthe log details.  Look for the \"credential detected\" flag.   You can close the browser tabs to Gmail and Gophish.  You're done with this section of the lab.",
            "title": "Verification"
        },
        {
            "location": "/mfa/",
            "text": "Multi-Factor Authentication\n\n\n\nDuo Setup\n\n\n\n\nCreate account\n\n\nRegister device\n\n\nSet up application\n\n\n\n\nFirewall Configuration\n\n\nIn the \nDevice\n tab, add a Multi Factor Authentication server profile:\n\n\n\n\nProfile Name\n: DUO_MFA\n\n\nCertificate Profile\n: Duo-Cert-Profile (certificates have been imported for you already)\n\n\nMFA Vendor\n: Duo v2\n\n\nAPI Host\n, \nIntegration Key\n, and \nSecret Key\n are specific to your Duo account.\n\n\n\n\n\n\nAdd a new \nAuthentication Profile\n by cloning the existing LDAP_Auth profile.  Call it \n\nLDAP_MFA\n, and add the \nDUO_MFA\n profile to it as an additional factor.\n\n\n\n\nCaptive Portal is used to deliver the MFA prompt, so that needs to be configured next.  There\nshould be a self-signed certificate for the portal already created (CP-MFA), as well as a SSL/TLS\nprofile (CP_MFA_SSL) for you to use.\n\n\nConfigure Captive Portal for the GP tunnel interface as shown:\n\n\n\n\nWe want GlobalProtect to prompt us to authenticate for applications that aren't web based, so we\nneed to add those settings.  In the Agent config section of the GlobalProtect portal configuration,\nclick on the \nApp\n tab and include the following settings:\n\n\n\n\nEnable Inbound Authentication Prompts from MFA Gateways\n: Yes\n\n\nNetwork Port for Inbound Authentication Prompts (UDP)\n: 4501\n\n\nTrusted MFA Gateways\n: 172.16.10.1\n\n\n\n\n\n\nIn \nObjects > Authentication\n, create a new authentication object using the authentication \nprofile.\n\n\n\n\nIn the \nAuthentication\n policy, create a rule to trigger the challenge for traffic destined for\nour web server.  Set the timeout to a smaller value (1 minute) to make testing easier.\n\n\n\n\n\n\nPolicy Name:\n Require MFA\n\n\nSource Zone:\n GP\n\n\nDestination Zone:\n TRUST\n\n\nDestination Address:\n 10.0.1.12\n\n\nService:\n service-http, service-rdp\n\n\nAuthentication Enforcement:\n Duo-Authentication\n\n\n\n\nFinally, create a \nSecurity\n policy allowing traffic to the web server.\n\n\n\n\n\n\nPolicy Name:\n Lab MFA Test\n\n\nSource Zone:\n GP\n\n\nDestination Zone:\n TRUST\n\n\nDestination Address:\n 10.0.1.12\n\n\nApplication:\n web-browsing, ms-rdp\n\n\nService:\n application-default\n\n\nAction:\n allow\n\n\n\n\nCommit the configuration.\n\n\nVerification\n\n\nOn the menu of your GlobalProtect client, click \nRediscover Network\n to make sure it has the\nlatest configuration from the Portal.\n\n\nOpen a browser and connect to \nhttp://web1.credlab.local\n.  When \ndirected to the captive portal page, accept the self-signed certificate warning prompt.\n\n\nLog in to the captive portal page using the username and password corresponding to the user that \nyou enrolled in Duo.  The first factor authentication will be done against the LDAP server.\n\n\n\n\nOnce the first factor has succeeded, the user is redirected to the second factor page.  In this \nlab, a push notification is sent to the user's device for the second factor authentication.\n\nOn your device, either allow or deny the access.\n\n\n\n\nOn the firewall under \nMonitor > Logs > Authentication\n, you can view the authentication logs.\nNote the two authentications, one for LDAP and one for Duo.\n\n\n  \n\n\nIf you opted to approve the authentication using the Duo app, the authentication will succeed and \nyou will be redirected to the restricted site, which in our case is just the IIS default page.\n\n\n\n\nYou can also deliver authentication challenges for applications that are not web-based.  Open \nRemote Desktop and attempt to connect to web1.credlab.local.  The initial connection will fail, but\nthe GlobalProtect client will display a pop-up asking you to authenticate.  Click the link to open\nthe captive portal page, and authenticate as before.\n\n\n\n\nAfter authenticating, attempt the Remote Desktop connection again and you should be able to connect\nto the server.\n\n\n\n\nYou're done with this section of the lab.",
            "title": "Multi-Factor Authentication"
        },
        {
            "location": "/mfa/#duo-setup",
            "text": "Create account  Register device  Set up application",
            "title": "Duo Setup"
        },
        {
            "location": "/mfa/#firewall-configuration",
            "text": "In the  Device  tab, add a Multi Factor Authentication server profile:   Profile Name : DUO_MFA  Certificate Profile : Duo-Cert-Profile (certificates have been imported for you already)  MFA Vendor : Duo v2  API Host ,  Integration Key , and  Secret Key  are specific to your Duo account.    Add a new  Authentication Profile  by cloning the existing LDAP_Auth profile.  Call it  LDAP_MFA , and add the  DUO_MFA  profile to it as an additional factor.   Captive Portal is used to deliver the MFA prompt, so that needs to be configured next.  There\nshould be a self-signed certificate for the portal already created (CP-MFA), as well as a SSL/TLS\nprofile (CP_MFA_SSL) for you to use.  Configure Captive Portal for the GP tunnel interface as shown:   We want GlobalProtect to prompt us to authenticate for applications that aren't web based, so we\nneed to add those settings.  In the Agent config section of the GlobalProtect portal configuration,\nclick on the  App  tab and include the following settings:   Enable Inbound Authentication Prompts from MFA Gateways : Yes  Network Port for Inbound Authentication Prompts (UDP) : 4501  Trusted MFA Gateways : 172.16.10.1    In  Objects > Authentication , create a new authentication object using the authentication \nprofile.   In the  Authentication  policy, create a rule to trigger the challenge for traffic destined for\nour web server.  Set the timeout to a smaller value (1 minute) to make testing easier.    Policy Name:  Require MFA  Source Zone:  GP  Destination Zone:  TRUST  Destination Address:  10.0.1.12  Service:  service-http, service-rdp  Authentication Enforcement:  Duo-Authentication   Finally, create a  Security  policy allowing traffic to the web server.    Policy Name:  Lab MFA Test  Source Zone:  GP  Destination Zone:  TRUST  Destination Address:  10.0.1.12  Application:  web-browsing, ms-rdp  Service:  application-default  Action:  allow   Commit the configuration.",
            "title": "Firewall Configuration"
        },
        {
            "location": "/mfa/#verification",
            "text": "On the menu of your GlobalProtect client, click  Rediscover Network  to make sure it has the\nlatest configuration from the Portal.  Open a browser and connect to  http://web1.credlab.local .  When \ndirected to the captive portal page, accept the self-signed certificate warning prompt.  Log in to the captive portal page using the username and password corresponding to the user that \nyou enrolled in Duo.  The first factor authentication will be done against the LDAP server.   Once the first factor has succeeded, the user is redirected to the second factor page.  In this \nlab, a push notification is sent to the user's device for the second factor authentication. \nOn your device, either allow or deny the access.   On the firewall under  Monitor > Logs > Authentication , you can view the authentication logs.\nNote the two authentications, one for LDAP and one for Duo.      If you opted to approve the authentication using the Duo app, the authentication will succeed and \nyou will be redirected to the restricted site, which in our case is just the IIS default page.   You can also deliver authentication challenges for applications that are not web-based.  Open \nRemote Desktop and attempt to connect to web1.credlab.local.  The initial connection will fail, but\nthe GlobalProtect client will display a pop-up asking you to authenticate.  Click the link to open\nthe captive portal page, and authenticate as before.   After authenticating, attempt the Remote Desktop connection again and you should be able to connect\nto the server.   You're done with this section of the lab.",
            "title": "Verification"
        }
    ]
}