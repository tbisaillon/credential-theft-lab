<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Credential Phishing Prevention - Credential Theft Lab</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Credential Phishing Prevention";
    var mkdocs_page_input_path = "credentialphishing.md";
    var mkdocs_page_url = "/credentialphishing/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Credential Theft Lab</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Overview</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../gettingstarted/">Getting Started</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../priorconfiguration/">What's Been Done For You</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Credential Phishing Prevention</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#phishing-campaign-configuration">Phishing Campaign Configuration</a></li>
    

    <li class="toctree-l2"><a href="#firewall-configuration">Firewall Configuration</a></li>
    

    <li class="toctree-l2"><a href="#verification">Verification</a></li>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../mfa/">Multi-Factor Authentication</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Credential Theft Lab</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Credential Phishing Prevention</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1>Credential Phishing Prevention</h1>

<p>There are 3 methods to check for corporate credential submissions that you can use on the firewall
to detect users when they submit credentials to web pages.</p>
<p>The three methods are:</p>
<ol>
<li>Group Mapping</li>
<li>IP User Mapping</li>
<li>Domain Credential Filter</li>
</ol>
<p>In this lab, you will configure the firewall to check submitted credentials via the <strong>Domain 
Credential Filter</strong> method.</p>
<hr />
<h1>Configuration Steps</h1>

<h3 id="phishing-campaign-configuration">Phishing Campaign Configuration</h3>
<p>From your laptop, open the GlobalProtect Agent.  If you don't have it installed, install it when 
prompted by the portal.  Connect to your lab environment's GlobalProtect portal using any of the 
user accounts listed in Table 2.</p>
<p>Access your phishing campaign admin site with the credentials <strong>admin/gophish</strong>.</p>
<p><img alt="Phishing Campaign 1" src="../img/phishing_campaign_1.png" /></p>
<p>In the <strong>Users &amp; Groups</strong> tab, edit the <strong>Phishing Recipients</strong> </p>
<p><img alt="Phishing Campaign 2" src="../img/phishing_campaign_2.png" /></p>
<p>Change the recipient to be your test email account.</p>
<p><img alt="Phishing Campaign 3" src="../img/phishing_campaign_3.png" /></p>
<p>Now, in the <strong>Campaigns</strong> tab, click the <strong>New Campaign</strong> button.</p>
<p><img alt="Phishing Campaign 4" src="../img/phishing_campaign_4.png" /></p>
<p>Fill out the campaign as shown, then click <strong>Launch Campaign</strong>.  Pay particular attention to the 
misspelled domain name <strong>paloaito.sso.com</strong> that we are spoofing!</p>
<p><img alt="Phishing Campaign 5" src="../img/phishing_campaign_5.png" /></p>
<p>GoPhish will queue and send the emails.  You can refresh this page and check that an email has been
sent to your test user.</p>
<p><img alt="Phishing Campaign 6" src="../img/phishing_campaign_6.png" /></p>
<p>If you want, log into your test email account, and verify that you've received your phishing email.</p>
<p><img alt="Phishing Campaign 7" src="../img/phishing_campaign_7.png" /></p>
<hr />
<h3 id="firewall-configuration">Firewall Configuration</h3>
<p>Log in to the GUI of your firewall, and add a User-ID agent.</p>
<ul>
<li><strong>Name:</strong> RODC</li>
<li><strong>Host:</strong> 10.0.1.11</li>
<li><strong>Port:</strong> 5007</li>
<li>Make sure the <strong>Enabled</strong> check box is ticked.</li>
</ul>
<p><img alt="User-ID Agent" src="../img/uid_agent.png" /></p>
<p><strong>Note:</strong> The service route configuration of the firewall has already been modified to communicate
with the User-ID agent via the firewall's trust interface.  To confirm it has been set up correctly,
under <strong>Device &gt; Setup &gt; Services</strong>, select <strong>Service Route Configuration</strong> and choose 
<strong>Customize</strong>.  In the IPv4 tab, select UID Agent service and verify that it is the interface in 
the <em>trust</em> zone (ethernet1/2).</p>
<p>Commit your changes.  After the commit completes, go back to the User-ID Agents tab.  The connected
column will change from orange to green.</p>
<p><img alt="User-ID Agent 2" src="../img/uid_agent_2.png" /></p>
<p>To make sure our test URL is categorized the way we want it, create a custom URL category for the 
URL <strong>paloaito.sso.com</strong>.  <em>(Note the misspelling!)</em></p>
<p><img alt="Custom URL Category" src="../img/custom_category.png" /></p>
<p>Select <strong>Objects &gt; Security Profiles &gt; URL Filtering</strong> and select the default URL Filtering profile.
Clone it, and change the cloned profile name to "credential-phish-block".  Use the Categories tab 
to set all URL categories to alert, but to block credential submissions.  </p>
<p><img alt="Credential Phish Profile 1" src="../img/credential_phish_profile_1.png" /></p>
<p>Now go to the <strong>User Credential Detection</strong> tab.  Choose <strong>Use Domain Credential Filter</strong> for the 
User Credential Detection method, and set the log severity to "high".</p>
<p><img alt="Credential Phish Profile 1" src="../img/credential_phish_profile_1.png" /></p>
<p>Go to the <strong>Policies &gt; Security</strong> tab, and create a new security policy.  Associate your new URL
filtering profile to the security policy with traffic from the GP zone to the PHISH zone.</p>
<ul>
<li><strong>Policy Name:</strong> Allow to Intranet</li>
<li><strong>Source Zone:</strong> GP</li>
<li><strong>Destination Zone:</strong> PHISH, TRUST</li>
<li><strong>Application</strong>: any</li>
<li><strong>Service:</strong> application-default</li>
<li><strong>Action:</strong> allow</li>
<li><strong>URL Profile:</strong> credential-phish-block</li>
</ul>
<p><img alt="Credential Phish Security Policy" src="../img/credential_phish_sec_policy.png" /></p>
<p>Commit the configuration.</p>
<hr />
<h3 id="verification">Verification</h3>
<p>Log into your test email account.  You should see that a phishing email has been received.  The
email contains a link that will open a phishing webpage mimicking the Palo Alto Networks corporate
SSO page.</p>
<p>Upon clicking the link provided in the email, you will get a phishing page with a form to submit
user credentials.</p>
<p><img alt="Credential Theft Test 1" src="../img/credential_phish_test_1.png" /></p>
<p><strong>Note:</strong> If you are NOT connected via GlobalProtect to your lab environment, you will get an 
"under construction" web page similar to below.  Do not proceed until you get the test phishing 
page.</p>
<p>Enter a username <strong>not</strong> in Table 2, and any password you'd like.  Click <strong>Login</strong>.</p>
<p><img alt="Credential Theft Test 2" src="../img/credential_phish_test_2.png" /></p>
<p>At this point, those credentials have been phished.  You will be redirected to a legitimate site.</p>
<p><img alt="Credential Theft Test 3" src="../img/credential_phish_test_3.png" /></p>
<p>Now log in to your credential phishing campaign's admin web site.</p>
<p><img alt="Credential Theft Test 4" src="../img/credential_phish_test_4.png" /></p>
<p>Next to the PANW campaign, click the View Results icon in the bottom right corner to get the 
campaign details.  Scroll down to your username, click the triangle icon, and expand the details:</p>
<p>Scroll down to the bottom "Submitted Data" section, and click the triangle icon next to "View 
Details".  You will see the username and password you entered.</p>
<p><img alt="Credential Theft Test 5" src="../img/credential_phish_test_5.png" /></p>
<p>The above steps you performed show how easy it is to steal user credentials.  Credential phishing
is rampant.  It is easier than ever to phish a user for credentials.  This is especially true in
targetted attacks, where the attacker wants to get into a specific organaization.  A phishing attack
makes password complexity irrelevant; the attacker steals the password no matter how difficult it
is.</p>
<p>You will do a second test, but first, let's find out what usernames are defined on your firewall.
Connect to your firewall via SSH, and run the <code>show user ip-user-mapping all</code> command.</p>
<p><img alt="Credential Theft Test 6" src="../img/credential_phish_test_6.png" /></p>
<p>Confirm that your username is listed (it will be if you are connected to the lab environment via 
GlobalProtect).  You may see additional IP/user mappings.</p>
<p>Go back to your test phishing account, and open the phishing email.  By clicking the link provided
in the email, you will get to the phishing page again.</p>
<p><img alt="Credential Theft Test 7" src="../img/credential_phish_test_7.png" /></p>
<p>Try submitting true "corporate" credentials by submitting the credentials you are connected to 
GlobalProtect with.</p>
<p>Since the source IP address of a session had a known User-ID, and the HTTP POST parameter in that
session matched the password belonging to that User-ID, the firewall detected a credential 
submission and the URL will be blocked.</p>
<p>You will get this message:</p>
<p><img alt="Credential Theft Test 8" src="../img/credential_phish_test_8.png" /></p>
<p>You can see more info about this process using these commands:</p>
<ul>
<li><code>show user user-id-agent state all</code></li>
<li><code>less mp-log useridd.log</code> - You can find detailed logs in useridd.log.  This log now includes 
  credential related logs, as well as bloomfilter updates.</li>
</ul>
<p>In the output of <code>show user user-id-agent state all</code>, look for the following:</p>
<p><img alt="Credential Theft Test 9" src="../img/credential_phish_test_9.png" /></p>
<p>Now examine the firewall's URL filtering logs.  Locate the log that matches your username, and view
the log details.  Look for the "credential detected" flag.</p>
<p><img alt="Credential Theft Test 10" src="../img/credential_phish_test_10.png" /></p>
<p>You can close the browser tabs to Gmail and Gophish.  You're done with this section of the lab.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../mfa/" class="btn btn-neutral float-right" title="Multi-Factor Authentication">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../priorconfiguration/" class="btn btn-neutral" title="What's Been Done For You"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../priorconfiguration/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../mfa/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
